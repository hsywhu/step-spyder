
<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE-edge,chrome=1">
<meta name="viewport" content="initial-scale=1, width=device-width, maximum-scale=1, minimum-scale=1, user-scalable=no">    
    <link href="/css/base.css" media="screen" rel="stylesheet" type="text/css">
<link href="/css/font-awesome.min.css" media="screen" rel="stylesheet" type="text/css">
<link href="/css/course/experiment-v3.css" media="screen" rel="stylesheet" type="text/css">
<link href="/favicon.ico" rel="shortcut icon">    <script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/jquery.lazyload.min.js"></script>
<script type="text/javascript" src="/js/base.js"></script>
<script type="text/javascript" src="/js/tool/note.js"></script>
<script type="text/javascript" src="/js/tool/discuss.js"></script>     <title>DVWA之php+mysql手工注入-网络安全实验课(2017) - 武汉大学-</title> 
</head>
 
 
<script type="text/javascript" src="/js/layer/laytpl.js"></script>
<script type="text/javascript" src="/js/layer/layer.js"></script>
<link rel="stylesheet" href="/editor.md-master/css/editormd.preview.css" />
<script type="text/javascript" src="/js/course/all.min.js"></script>
<script type="text/javascript" src="/js/course/jquery.md5.js"></script>
<script type="text/javascript">
    var chapter_id = 29;
    var courseware_id = 8142;
    var complete_time = 0;
    var student_id = 71446;
    var originalTime = "";
    var is_openstack = '1';
    var uuid=0;
</script>
<body>
<div class="tips_browser">为了您更好运行实验，建议您选择火狐浏览器<a target="_blank" title="立即下载火狐浏览器"
                                                 href="http://download.firefox.com.cn/releases/stub/official/zh-CN/Firefox-latest.exe">火狐浏览器</a>
    <span id="closetips" title="关闭"></span></div>
<!-- main -->
<div class="g-container clearfix">
    <input type="hidden" id="courseware_id" value="8142"/>
    <input type="hidden" id="chapter_id" value="29"/>
    <div class="toolbar">
        <a href="/course/8142" class="btn returnbtn"><i></i>返回课程</a>
        <a href="javascript:void(0);" class="btn startbtn" id="startbtn"><i></i><p id="startOrStop">开始</p></a>
        <a href="javascript:void(0);" class="btn stopbtn" id="stopbtn" style="display: none"><i></i><p id="startOrStop">关闭</p></a>
        <a href="javascript:void(0);" class="btn stopbtn" id="starting" style="display: none"><i></i><p id="startOrStop">启动中</p></a>
        <a href="javascript:void(0);" class="btn stopbtn" id="wrong" style="display: none"><i></i><p id="startOrStop">失败</p></a>
<!--        <a href="javascript:;" class="btn ipAdd" style="visibility:visible;">
            <em>操作机IP:</em>192.168.1.12
            <br>
            <em>目标机IP:</em>192.168.1.12
        </a>-->
        <div class="selectwrap" id='selectVm'>
                     </div>
        <a href="javascript:;" class="btn screenshotbtn" id="screenshot"><i></i> <span><b></b>截屏</span> </a>
        <!--<a href="javascript:;" class="btn copyVMbtn" id="copyVMbtn"><i></i> <span><b></b>复制到VM</span> </a>-->
        <a href="javascript:;" class="btn ctrlbtn" id="sendCtrlAltDel"><i></i> <span><b></b>发送 CTRL+ALT+DEL</span> </a>
        <a href="javascript:;" class="btn wd36 sharedesktopbtn" id="sharedesktopbtn"><i></i> <span><b></b>共享桌面</span> </a>
        <!--<a href="javascript:;" class="btn wd36 txtdownbtn"><i></i> <span><b></b>代码下载</span> </a>-->
        <a href="javascript:;" class="btn wd36 fullscreenbtn"><i id="quanping" onclick="quanping()"></i> <span><b></b>全屏显示</span>
        </a>
        <!--<a href="javascript:;" class="btn wd36 cutcreenbtn"><i></i> <span><b></b>实验录屏</span> </a>-->
<!--        <a href="javascript:;" class="btn timewrap">剩余时间<em>1</em>时<em>59</em>分<em>32</em>秒</a>-->
        <a href="javascript:;" class="btn timewrap" id="divOSTime">剩余时间<em>00</em>时<em>00</em>分<em>00</em>秒</a>
    </div>
    <div class="g-main">
        <!--id left-->
        <div id="vm-main">
            <div class="wait-logo" id="wait-logo"> <!--背景logo层 style="display: none;"-->  </div>
            <!--提示层-->
            <div class="tips_layerwrap"  style="display: none;" id="tishiceng">
                <div class="tips_layer">
                    <div class="sk-fading-circle">
                        <span class="percent" id="jindutiao">0%</span>
                        <div class="sk-circle1 sk-circle"></div>
                        <div class="sk-circle2 sk-circle"></div>
                        <div class="sk-circle3 sk-circle"></div>
                        <div class="sk-circle4 sk-circle"></div>
                        <div class="sk-circle5 sk-circle"></div>
                        <div class="sk-circle6 sk-circle"></div>
                        <div class="sk-circle7 sk-circle"></div>
                        <div class="sk-circle8 sk-circle"></div>
                        <div class="sk-circle9 sk-circle"></div>
                        <div class="sk-circle10 sk-circle"></div>
                        <div class="sk-circle11 sk-circle"></div>
                        <div class="sk-circle12 sk-circle"></div>
                    </div>
                    <p class="cld-1">正在努力的为您构建实验环境......</p>
                    <p class="cld-2">请耐心等待哦！等待时您可以先预习一下右侧的实验指导书</p>
                    <p class="cld-3">为了您更好运行实验，建议您选择火狐浏览器，设置屏幕分辨率为1366*768</p>
                </div>
            </div>
            <!--提示层-->
            <div id="display"><!--<img src="/images/course/1.jpg" height="100%">--></div>
            <div id="display-layer"></div>
        </div>

        <!--dragbox-->
        <ul id="dragIconBar">
            <li>
                <a href="javascript:;" class="icon1">指导<i></i></a>
                <span>指导</span>
            </li>
            <li>
                <a href="javascript:;" class="icon2">问答<i></i></a>
                <span>问答</span>
            </li>
            <li>
                <a href="javascript:;" class="icon3">笔记<i></i></a>
                <span>笔记</span>
            </li>
        </ul>
        <!---->
        <div id="leftdragbar"></div>
        <div id="dragbox">
            <!---->
            <div style="width:100%; height: 100%; position:relative;overflow: hidden;">

                <h2 class="draghand">鼠标按住拖动</h2>
                <div id="foldBar" title="最小化"></div>
                <div id="drag"><!--拖--></div>
                <div id="right"></div>
                <div id="bottom"></div>

                <!--inner-->


                <div class="dragTabList">
                    <ul class="rt_tabNav clearfix">
                        <li class="cur">指导</li>
                        <li onclick="discussList('#discuss_loadmore', 'discusslist_script', 'reply_ul', '/course/play/discusslist','8142','29','');">问答</li>
                        <li class="" onclick="noteList('#note_loadmore', 'note_script', 'note_ul', '/course/play/notelist','8142','29','');">笔记</li>
                    </ul>
                    <!---->
                    <div class="list_tab_con">

                        <ul class="tab_con">
                            <div class="add-member" id="addEval">

                                <div id="test-editormd-view2">
                                        <textarea id="append-test" style="display:none;"># DVWA之php+mysql手工注入
##【实验目的】
1)通过使用DVWA实例理解php中的Sql注入漏洞产生的原因及利用方法，结合实例掌握其加固方式。
## 【实验原理】
SQL Injection：在用户的输入没有为转义字符过滤时，就会发生这种形式的注入式攻击，它会被传递给一个SQL语句。这样就会导致应用程序的终端用户对数据库上的语句实施操纵。就是通过把SQL命令插入到Web表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令。
具体来说，它是利用现有应用程序，将（恶意）的SQL命令注入到后台数据库引擎执行的能力，它可以通过在Web表单中输入（恶意）SQL语句得到一个存在安全漏洞的网站上的数据库，而不是按照设计者意图去执行SQL语句。
## 【实验环境】
windows 2003:`192.168.1.3`
## 【实验步骤】
### 一、低安全等级文件包含
1.1使用浏览器打开`http://192.168.1.3:8080/dvwa/login.php`，输入用户名：admin密码：password进行登录。如图1所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_45413)</center>
<center>图1</center>

1.2登录需要将DVWA的安全级别调整为low(j见红框内)。调整之后选择SQL Injection，进入页面。如图2所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_48342)</center>
<center>图2</center>

1.3提示输入User ID，输入正确的ID，将显示 ID First name，Surname信息。如图3所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_64727)</center>
<center>图3</center>

1.4可以得知此处为注入点，尝试输入“’”，返回错误。如图4所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_58203)</center>
<center>图4</center>

1.5尝试遍历数据库表，提示输入的值是ID，可以初步判断此处为数字类型的注入。尝试输入：1 or 1=1 ，尝试遍历数据库表。如图5所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_24591)</center>
<center>图5</center>

1.6尝试输入：1 or 1=1,想要遍历数据库表，并没有达成目的，猜测程序将此处看成了字符型，可以尝试输入：1’ or ‘1’=’1后遍历出了数据库中的所有内容。下面尝试结合各种不同语句，得到不同的结果。如图6所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_87635)</center>
<center>图6</center>

1.7利用order by num语句来测试查询信息列表尝，修改num的值，这里我们输入" 1'order by 1 - - "结果页面正常显示，注意- -后面有空格。继续测试，" 1'order by 2 - - "," 1'order by 3 - - "，当输入3是，页面报错。页面错误信息如下，Unknown column '3' in 'order clause'，由此我们判断查询结果值为2列。如图7所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_15397)</center>
<center>图7</center>

1.8 通过使用user()，database()，version()三个内置函数得到连接数据库的账户名、数据库名称，数据库版本信息，首先参数注入：`1' and 1=2 union select 1,2 --。` （注意― 后有空格）。如图8所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_23692)</center>
<center>图8</center>

由上图得知，从而得出First name处显示结果为查询结果第一列的值，surname处显示结果为查询结果第二列的值。
1.9在得知显示之后，使用user()，database()，version()三个内置函数得到连接数据库的账户名、数据库名称，数据库版本信息。通过注入：`1' and 1=2 union select user(),database() --`得到数据库用户以及数据库名称（注意--后有空格）。连接数据库的用户为root@localhost,数据库名称为dvwa,。如图9所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_62655)</center>
<center>图9</center>

1.10通过注入：`1' and 1=2 union select version(),database() -- `得到数据库版本信息，此处数据版本为：5.0.90-community-nt 。如图10所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_83473)</center>
<center>图10</center>

1.11通过注入：`1'and 1=2 union select 1,@@global.version_compile_os from mysql.user --`获得操作系统信息。如图11所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_94423)</center>
<center>图11</center>

1.12通过注入：`1' and 1=2 union select 1,schema_name from information_schema.schemata -- `（注意― 后有空格）查询mysql数据库，所有数据库名字：这里利用mysql默认的数据库infromation_schema，该数据库存储了Mysql所有数据库和表的信息。如图12所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_21763)</center>
<center>图12</center>

1.13通过注入：`1' and exists(select * from users) -- `猜解dvwa数据库中的表名。利用1‘ and exists(select * from 表名)，这里测试的结果，表名为users，在真实渗透测试环境中，攻击者往往关心存储管理员用户与密码信息的表。如图13所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_36450)</center>
<center>图13</center>

1.14 猜解字段名：`1' and exists(select 表名 from users) --`,这里测试的字段名有first_name,last_name使用：`1' and exists(select first_name from users) -- 和1' and exists(select last_name from users) `C猜解字段名。如图14所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_21940)</center>
<center>图14</center>

1.15爆出数据库中字段的内容` 1' and 1=2 union select first_name,last_name from users -- `,这里其实如果是存放管理员账户的表，那么用户名，密码信息字段就可以爆出来了。如图15所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_94412)</center>
<center>图15</center>

1.16查看low等级源代码。如图16所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_37330)</center>
<center>图16</center>

通过代码可以看出，对输入$id的值没有进行任何过滤就直接放入了SQL语句中进行处理，这样带来了极大的隐患。
### 二、中等等级代码分析
2.1 将DVWA安全级别调整为medium，查看源代码。如图17所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_95600)</center>
<center>图17</center>

通过源代码可以看出，在中等级别时对输入的$id的值使用mysql_real_eascape_string()函数进行了处理。在PHP中，使用mysql_real_eascape_string()函数用来转义SQL语句中使用字符串的特殊字符。但是使用这个函数对参数进行转换是存在绕过的。只需要将攻击字符进行转换一下编码格式即可绕过该防护函数。比如使用url编码等方式。同时发现SQL语句中变成了“WHERE user_id = $id”，此处变成了数字型注入，所以此处使用mysql_real_escape_string()函数并没有起到防护的作用。可以通过类似于“1 or 1= 1”的语句来进行注入。
### 三、高等级代码分析
3.1 将DVWA安全级别调整为medium，查看源代码。如图18所示
<center>![](http://img.shiyanbar.net/UploadImage/2016/3/7/20_75240)</center>
<center>图18</center>

从源代码中可以看出，此处认为字符型注入。对传入$id的值使用stripslashes()函数处理以后，在经过到$mysql_real_escape_string()函数进行第二次过滤。在默认情况下，PHP会对所有的GET，POST，,和cookie数据自动运行addslashes()，adslashers()函数返回在部分与定义之前添加反斜杠。就是将“’”变成“\’”，Stripslashes()函数则是删除由addslashes()函数添加的反斜杠。在使用两个函数进行过滤之后再使用is_numric()函数检查$id的值是否为数字，彻底断绝了注入的存在。此种防护不存在绕过的可能。
## 【实验思考】
1.如果为字符型注入，且防护不完善，该如何绕过。


<form  id="form1" class="editform1">
<h2>题目一 下列那个函数不是对php的过滤函数：（）</h2>
<label><input type="radio" name="result" value="A" />A  mysql_query()</label>
<label><input type="radio" name="result" value="B" />B  mysql_real_escape_string()</label>
<label><input type="radio" name="result" value="C" />C  stripslashes()</label>
<label><input type="radio" name="result" value="D" />D  addslashes()</label>
<input type="button" onclick="checkAnswer('form1')" value="提交" class="btn1" />
<div class="tipstext"> </div>
<input type="hidden" name="number" value='1' />
</form>





</textarea>
                                </div>
                                <script src="/editor.md-master/lib/marked.min.js"></script>
                                <script src="/editor.md-master/lib/prettify.min.js"></script>

                                <script src="/editor.md-master/lib/raphael.min.js"></script>
                                <script src="/editor.md-master/lib/underscore.min.js"></script>
<!--                                    <script src="/editor.md-master/lib/sequence-diagram.min.js"></script>
                                <script src="/editor.md-master/lib/flowchart.min.js"></script>
                                <script src="/editor.md-master/lib/jquery.flowchart.min.js"></script>-->

                                <script src="/editor.md-master/editormd.js"></script>
                                <script type="text/javascript">
                                    $(function () {
                                        var testEditormdView2;

                                        testEditormdView2 = editormd.markdownToHTML("test-editormd-view2", {
                                            //markdown        : "" ,
                                            htmlDecode      : "style,script,iframe",  // you can filter tags decode
                                            tocm            : true,                              
                                            emoji           : true,
                                            taskList        : true,
                                            tex             : false,  
                                            flowChart       : false,  
                                            sequenceDiagram : false,
                                            tocStartLevel : 2,

                                        });


                                    });
                                </script>

                            </div>
                        </ul>

                        <ul class="AQ tab_con" style="display:none;">
                            <!-- 评论 -->
                            <div class="pl-input-wrap">
                                <form action="" method="post" class="form">
                                    <div class="pl-input-inner">
                                        <textarea id="discuss" class="chackTextarea" onkeyup="words_deal();"    onclick="myFocus()" onfocus="myFocus()" onblur="myBlur()" placeholder="字数限制140字！"></textarea>
                                    </div>
                                    <div class="pl-input-btm clearfix">
    <!--                                    <dl class="userSetTab">
                                            <dt class="cur"><i></i>吐槽</dt>
                                            <dt><i></i>问题</dt>
                                        </dl>已经去掉-->
                                        <p class="num-limit"><b class="num">140</b>字</p>
                                        <input type="button" class="course-btn r" onclick="release(this)" value="提交">
                                    </div>
                                </form>
                            </div>
                            <!--评论list-->
                <div class="noteswrap">
    <div class="wrapexperselect clearfix">
        <div class="filter-btn">
            <label>
                <input id="discuss_myself" type="checkbox" name="">
                <span>只看自己</span>
            </label>
        </div>
    </div>
		<script id="discusslist_script" type="text/html">
		{{# for(var i =0,len = d.paginator.length;i<len;i++){ }}
		<li class="clr">
			<div class="ds_author QAauthor">
                            <img alt="{{# if(d.paginator[i].name == null){ }}{{ d.paginator[i].NickName }}{{# }else { }}{{ d.paginator[i].name }}{{# } }}" src="{{ d.paginator[i].Image }}">
                            <h3 title="{{# if(d.paginator[i].name == null){ }}{{ d.paginator[i].NickName }}{{# }else { }}{{ d.paginator[i].name }}{{# } }}">{{# if(d.paginator[i].name == null){ }}{{ d.paginator[i].NickName }}{{# }else { }}{{ d.paginator[i].name }}{{# } }}</h3>
                            <span class="icontips QA"></span>
			</div>
			<div class="ds_content QAcontent">
				<div class="asktitlecon">
					<span style="word-wrap:break-word;word-break:break-all;">{{ d.paginator[i].content }}</span>
					<span class="answer"><i></i>
											<a href="javascript:;" onclick="javascript:deploy(this,{{ (i+1) }},{{ d.paginator[i].reple_count }},'{{ d.paginator[i].name }}','{{ d.paginator[i].NickName }}');">回答({{ d.paginator[i].reple_count }})</a>
									</div>
				<div class="ds_btom QAbtom">
					<span class="time">{{ d.paginator[i].create_time }}</span>
					<span class="from">来自：<a href="/course/{{ d.paginator[i].courseware_id }}/vid/{{ d.paginator[i].chapter_id }}">{{ d.paginator[i].chapter_name }}</a></span>
				</div>
				<!--回答-->
				<ul id="reply_{{ (i+1) }}" class="reply_content"  style="display:none">
					<div class="pl-input-wrap child-input-Wrap">
						{{# for(var r=0,rlen=d.paginator[i].reply_list.length;r<rlen;r++){ }}
						<li class="clr">
							<div class="ds_author QAauthor">
                                                            <img alt="{{# if(d.paginator[i].reply_list[r].name == null){ }}{{ d.paginator[i].reply_list[r].NickName }}{{# }else { }}{{ d.paginator[i].reply_list[r].name }}{{# } }}"  src="{{ d.paginator[i].reply_list[r].Image }}">
                                                            <h3 title="{{# if(d.paginator[i].reply_list[r].name == null){ }}{{ d.paginator[i].reply_list[r].NickName }}{{# }else { }}{{ d.paginator[i].reply_list[r].name }}{{# } }}">{{# if(d.paginator[i].reply_list[r].name == null){ }}{{ d.paginator[i].reply_list[r].NickName }}{{# }else { }}{{ d.paginator[i].reply_list[r].name }}{{# } }}</h3>
							</div>
							<div class="ds_content_wrap">
								<div class="ds_content QAcontent">
									<div class="asktitlecon" style="word-wrap:break-word;word-break:break-all;">
										{{ d.paginator[i].reply_list[r].tag }}
										{{ d.paginator[i].reply_list[r].content }}
										<span class="answer"><a href="javascript:;" onclick="subreple(this,{{ d.paginator[i].reply_list[r].id }},{{ d.paginator[i].reply_list[r].main_parent_id }},'{{ d.paginator[i].reply_list[r].name }}',{{ (i+1) }},{{ d.paginator[i].reply_list[r].student_id  }},'{{ d.paginator[i].reply_list[r].NickName }}');">回复</a></span>
									</div>
									<div class="ds_btom QAbtom">
										<span class="time">{{ d.paginator[i].reply_list[r].create_time }}</span>
										<span class="floor">{{ (r+1) }}楼</span>
									</div>
								</div>
							</div>
						</li>
						{{# } }}
						<form id="form_{{ (i+1) }}" method="post" class="form">
							<div class="child-pl-wrap">
								<div class="pl-input-inner">
                                    <textarea wrap="physical" class="chackTextarea textarea_{{ (i+1) }}" onfocus="myFocus()" onblur="myBlur()" placeholder=""  ></textarea>
								</div>
								<div class="pl-input-btm clearfix">
									<input type="button" class="course-btn cancel r" value="取消" onclick="close_form(this,{{ (i+1) }});"  >
									<input type="button" class="course-btn r" value="回复" reple_tag='1' to_student_id="" reple_id="{{ d.paginator[i].id }}" id="inp_{{ (i+1) }}" main_parent_id="" onclick="reple(this,{{ d.paginator[i].courseware_id }},{{ d.paginator[i].chapter_id }},{{ d.paginator[i].course_id }},{{ d.paginator[i].state }},{{ d.paginator[i].id }},{{ (i+1) }},{{ d.paginator[i].student_id }});" >
								</div>
							</div>
						</form>
					</div>
				</ul>
				<!--回答 end-->
			</div>
		</li>
		{{# } }}<!--问答-->
		</script>
		<ul class="notes-list-wrap qa-list-wrap" id="reply_ul"></ul><!--模板引擎渲染容器-->
</div>
<!--加载更多-->
	<div class="loadmore-wrap">
	<button  id="discuss_loadmore" class="loadmore" onclick="javascript:discussList('#discuss_loadmore', 'discusslist_script', 'reply_ul', '/course/play/discusslist','',0,0,'append');" bind-page-index="1">加载更多</button>
</div> 
                        </ul>
                        <ul class="notes tab_con" style="display:none;">
                            <!-- 笔记 -->
                            <div class="pl-input-notes">
                                <form action="" method="post" class="form">
                                    <div class="pl-input-inner">
                                        <textarea id="note" onkeyup="words_deal1();" class="chackTextarea"   onclick="myFocus()"  onfocus="myFocus()" onblur="myBlur()" placeholder="记录学习点滴"></textarea>
                                    </div>
                                    <div class="pl-input-btm clearfix">
                                        <dl class="cell_notes">
                                            <dt id="share" class="share curshare"><i></i>分享</dt>
                                        </dl>
                                        <p class="num-limit"><b class="notesNum">1000</b>字</p>
                                        <input type="button" class="course-btn r" onclick="releaseNote(this)" value="提交">
                                    </div>
                                </form>
                            </div>
                            <!--笔记list-->
                            <div class="noteswrap">
    <div class="wrapexperselect clearfix">
        <div class="filter-btn">
            <label>
                <input id="note_myself" type="checkbox" name="">
                <span>只看自己</span>
            </label>
        </div>
    </div>
	<script id="note_script" type="text/html">
	{{# for(var i =0,len = d.paginator.length;i<len;i++){ }}
		<li class="clearfix">
			<div class="ds_author">
                            <img src="{{ d.paginator[i]['Image'] }}">
                            <h3 title="{{# if(d.paginator[i].name == null){ }}{{ d.paginator[i].NickName }}{{# }else { }}{{ d.paginator[i].name }}{{# } }}">{{# if(d.paginator[i].name == null){ }}{{ d.paginator[i].NickName }}{{# }else { }}{{ d.paginator[i].name }}{{# } }}</h3>
			</div>
			<div class="ds_content">
				<div class="asktitlecon" style="word-wrap:break-word;word-break:break-all;"><span>
					{{ d.paginator[i]['note'] }}
				</span>
				</div>
				<div class="ds_btom"><span class="time">{{ d.paginator[i]['create_time'] }}</span>
					<span class="from">源自：<a href="/course/{{ d.paginator[i]['courseware_id'] }}/vid/{{ d.paginator[i]['chapter_id'] }}">{{ d.paginator[i]['chapter_name'] }}</a></span>
				</div>
			</div>
		</li>
	{{# } }}
	</script>
	<ul class="notes-list-wrap" id="note_ul"> </ul>
	<!--加载更多-->
	<div class="loadmore-wrap">
            <button  id="note_loadmore" class="loadmore"  onclick="javascript:noteList(note_loadmore,'note_script','note_ul','/course/play/notelist','',0,0,'append');" bind-page-index="1">加载更多</button>
	</div>
</div>                        </ul>
                    </div>


                </div>

                <!--inner end-->
            </div>
        </div>
        <div id="dragMask"></div>
        <!--dragbox end-->


    </div>
    <!--提示窗
    <dl class="tips_layer">
        <dt><img src="/images/video/1.jpg"></dt>
        <dd>您前面有12位在等待ing..</dd>
    </dl>-->
</div>

<!-- main end -->
<div class="MaskWrap" style="display:none;">
    <!--半透明底色-->
</div>
<!--复制到VM-->
<div class="poplayer" style="display:none;" id="copyVMwrap">
    <div class="close"></div>
    <div class="tiptop"><span>复制到VM</span></div>
    <div class="tipinfo">
        <ul class="txt">
            <li><b>向虚拟机中拷贝内容：</b>将内容复制到剪贴板输入框，点击“提交”，在虚拟机中使用粘贴</li>
            <li><b>由虚拟机向外拷贝内容：</b>输入框中默认显示实验环境剪贴板的内容（在虚拟机中Ctrl-C或右键点击复制获取）</li>
            <div class="pl-input-inner input-inner">
                <textarea class="chackTextarea" style="height:130px;"id="noVNC_clipboard_text"   onclick="myFocus()"  onfocus="myFocus()" onblur="myBlur()" ></textarea>
            </div>
            <div class="sure clearfix">
                <input type="button" class="course-btn r" value="确定" id="VMsure">
                <input type="button" class="course-btn l" id='VMcancel' value="取消">
            </div>
        </ul>
    </div>
</div>
<!--复制到VM end-->
<div class="poplayer" style="display:none;" id="sharedesktopwrap">
    <div class="close"></div>
    <div class="tiptop"><span>共享桌面</span></div>
    <div class="tipinfo">
        <ul class="txt txtdesk">
<!--            <li>
                <p class="blue">只读模式</p>
                <p>复制以下链接发给朋友，让他围观你的桌面操作</p>
                <input class="bgcolor" id="viewOnly"  onclick="myFocus()" onfocus="myFocus()" onblur="myBlur()" value="http:///">
            </li>-->
            <li>
                <p class="blue">协作模式</p>
                <p>复制以下链接发给朋友，邀请他远程协助，与你共同完成实验任务</p>
                <input class="bgcolor" id="viewSupport"   onclick="myFocus()"  onfocus="myFocus()" onblur="myBlur()" value="http://210.42.123.10:8081/">
            </li>
        </ul>
    </div>
</div>
<!--共享桌面 end-->
<div class="poplayer" style="display:none; width:550px;" id="stopwrap">
    <div class="close"></div>
    <div class="tiptop"><span>停止实验</span></div>
    <div class="tipinfo">
        <ul class="txt">
            <li>
                <p>停止实验后虚拟机将被<span style="color:#ff021d">删除</span>！<br>
<a href="#" style="color:#089bef;"></a></p>
         <a href="#" class="downloadbtn r" onclick="stopVm()" id="guanbixuniji">关闭虚拟机</a>
            </li>

        </ul>
    </div>
</div>
<!--停止实验 end-->
</body>


<!-- 页面级 -->
<script src="/js/course/jquey-bigic.js" type="text/javascript"></script>
<script src="/js/course/experiment-v3.js" type="text/javascript"></script>
<script src="/js/course/os-function.js" type="text/javascript"></script>
<script type="text/javascript">
//===================== guacamole ====================================//
var left_h = $(window).height()-55;
var left_w = $('.g-main').width();
var x = $('.g-main').width();
var y = $(window).height()-55;

var windows = $(window);
var l = $("#VMsure");
var c = $("#noVNC_clipboard_text");
var siteType = 1;
var tunnel;
var url = '';
var guac;
var guacHost;
var display;
var keyboard;
var tunnel;
var mouse;

var stopTime = false;
var os_time = "01:20:00";
var array = os_time.replace("：", ":").split(":");
//小时 
var h = parseInt(array[0], 10);
//分 
var m = parseInt(array[1], 10);
//秒 
var s = parseInt(array[2], 10);
document.getElementById('divOSTime').innerHTML = SetStringTime(h, m, s);

function showTime() {
    if (stopTime == true) {
        h = parseInt(array[0], 10);
        m = parseInt(array[1], 10);
        s = parseInt(array[2], 10);
        return;
    }
    //倒计时结束后，停止虚拟机
    if (h == 0 && m == 0 && s == 0) {
        stopVm();
        h = parseInt(array[0], 10);
        m = parseInt(array[1], 10);
        s = parseInt(array[2], 10);
        return;
    }

    //当秒走到0时，再次为60秒 
    if (s == 0) {
        s = 60;
    }

    if (s == 60) {            
        //当分等于0时并且小时还多余1个小时的时候进里面看看
        if (m == 0 && h > 0) {
            //小时减一 
            h -= 1;
            //分钟自动默认为60分 
            m = 60;
            //秒自动默认为60秒 
            s = 60;
        }
        //每次当秒走到60秒时，分钟减一 
        m -= 1;
    }
    //秒继续跳动，减一 
    s -= 1;
    complete_time +=1;
    document.getElementById('divOSTime').innerHTML = SetStringTime(h, m, s);
    setTimeout('showTime()', 1000);
}
//时间字符格式化
function SetStringTime(h, m, s) {
    var sh = h;
    var sm = m;
    var ss = s;
    if (h > 0 && h < 10) {
        sh = "0" + h;
    }
    else if (h == 0) {
        sh = "00";
    }
    if (m > 0 && m < 10) {
        sm = "0" + m;
    }
    else if (m == 0) {
        sm = "00";
    }
    if (s > 0 && s < 10) {
        ss = "0" + s;
    }
    else if (s == 0) {
        ss = "00";
    }
    return '剩余时间<em>'+sh+'</em>时<em>'+sm+'</em>分<em>'+ss+'</em>秒';
    //return sh + ":" + sm + ":" + ss;
}
$("#display").mouseover(function(){
    $(this).css('z-index',-100);
});
$("#display").mouseout(function(){
    $(this).css('z-index',100);
});
$(document).ready(function () {
            reinitSize();
    var guac_width = $('.g-main').width();
    var guac_height = $('.g-main').height();
    var openInfo = common('/course/play/get-os-record','post',{'chapter_id':chapter_id,'courseware_id':courseware_id},'','');
    if(openInfo.status==1){
        guacHost = openInfo.data.guac_host;
    }else{
        guacHost = 'osdesktop.shiyanbar.com';
    }
    // If WebSocket available, try to use it.
    if (window.WebSocket)
        tunnel = new Guacamole.ChainedTunnel(
            new Guacamole.WebSocketTunnel((siteType == 0 ? "wss://" : "ws://") + guacHost + "/websocket-tunnel"),
            new Guacamole.HTTPTunnel((siteType == 0 ? "https://" : "http://") + guacHost + "/tunnel")
        );

    // If no WebSocket, then use HTTP.
    else
        tunnel = new Guacamole.HTTPTunnel((siteType == 0 ? "https://" : "http://") + guacHost + "/tunnel", !0)

    // Instantiate client
    guac = new Guacamole.Client(tunnel);
console.log(guac);
    $("#display").html(guac.getDisplay().getElement());
    display = guac.getDisplay();
     keyboard = new Guacamole.Keyboard(document);
     mouse = new Guacamole.Mouse(guac.getDisplay().getElement());
    guac.onerror = function (error) {       
        console.log(error);
        layer.alert('亲，网速不给力啊！请重新刷新');
    };
    function keydownEvent(keysym) {
        guac.sendKeyEvent(1, keysym);
    }
    function keyupEvent(keysym) {
        guac.sendKeyEvent(0, keysym);
    }
    // 调整虚拟机鼠标位置
    function sendScaledMouseState(mouseState) {
        var scaledState = new Guacamole.Mouse.State(
            mouseState.x / display.getScale(),
            mouseState.y / display.getScale(),
            mouseState.left,
            mouseState.middle,
            mouseState.right,
            mouseState.up,
            mouseState.down
        );
        guac.sendMouseState(scaledState);
    }
    function myMouseMove(mouseState) {
        // 隐藏虚拟机的鼠标指针
        display.showCursor(false);
        sendScaledMouseState(mouseState);
    };

    $('#sendCtrlAltDel').on("click", function () {
        var KEYSYM_CTRL   = 0xFFE3;
        var KEYSYM_ALT    = 0xFFE9;
        var KEYSYM_DELETE = 0xFFFF;
        guac.sendKeyEvent(1, KEYSYM_CTRL);
        guac.sendKeyEvent(1, KEYSYM_ALT);
        guac.sendKeyEvent(1, KEYSYM_DELETE);
        guac.sendKeyEvent(0, KEYSYM_DELETE);
        guac.sendKeyEvent(0, KEYSYM_ALT);
        guac.sendKeyEvent(0, KEYSYM_CTRL);
    });
    if(openInfo.status === 1){
        uuid = openInfo.data.support_connection_id;
        var unique = openInfo.data.unique;
//        $("#viewOnly").val("http://"+window.location.hostname+"/course/play/vm-view/uuid/"+unique+'/type/'+student_id);
        $("#viewSupport").val("http://"+window.location.hostname+"/course/play/vm-support/uuid/"+unique+'/type/'+student_id);
        $("#startbtn").hide();
        $("#starting").hide();
        $("#stopbtn").show();
        $("#wrong").hide();
        startExperiment = true;
        showTime();
        mark = setInterval("updateStudyTime()", 60000);
        $.ajax({
            type: "POST",
            async: false,
            url: (siteType == 0 ? "https://" : "http://") + guacHost + "/api/tokens",
            data: "username=desktop&password=asdfhqihwoerawfasdfasf",
        }).done(function (result) {
            //d = d + "&token=" + e.authToken + '&GUAC_DATA_SOURCE=default&GUAC_ID=vnc&GUAC_TYPE=c&GUAC_WIDTH=1920&GUAC_HEIGHT=500&GUAC_DPI=96&GUAC_AUDIO=audio%2Fogg&GUAC_AUDIO=audio%2Fmp4&GUAC_AUDIO=audio%2Fmpeg&GUAC_AUDIO=audio%2Fwebm&GUAC_AUDIO=audio%2Fwav&GUAC_VIDEO=video%2Fogg&GUAC_VIDEO=video%2Fmp4&GUAC_VIDEO=video%2Fwebm';
            url = "token="+ result.authToken + '&GUAC_DATA_SOURCE=mysql&GUAC_ID='+uuid+'&GUAC_TYPE=c&GUAC_WIDTH='+guac_width+'&GUAC_HEIGHT='+guac_height+'&GUAC_DPI=96&GUAC_AUDIO=audio%2Fogg&GUAC_AUDIO=audio%2Fmp4&GUAC_AUDIO=audio%2Fmpeg&GUAC_AUDIO=audio%2Fwebm&GUAC_AUDIO=audio%2Fwav&GUAC_VIDEO=video%2Fogg&GUAC_VIDEO=video%2Fmp4&GUAC_VIDEO=video%2Fwebm';
        }).fail(function (result) {
            console.error("token error: ", result.status, result.statusText)
        });
//        url = "token="+ openInfo.data.guac_token + '&GUAC_DATA_SOURCE=mysql&GUAC_ID='+uuid+'&GUAC_TYPE=c&GUAC_WIDTH='+guac_width+'&GUAC_HEIGHT='+guac_height+'&GUAC_DPI=96&GUAC_AUDIO=audio%2Fogg&GUAC_AUDIO=audio%2Fmp4&GUAC_AUDIO=audio%2Fmpeg&GUAC_AUDIO=audio%2Fwebm&GUAC_AUDIO=audio%2Fwav&GUAC_VIDEO=video%2Fogg&GUAC_VIDEO=video%2Fmp4&GUAC_VIDEO=video%2Fwebm';
        try{
            guac.connect(url);     
        }catch(ex){
            console.log("guac error"+ex.message());
        }
    
       
        $("#wait-logo").hide();
        $("#screenshot").on("click", function () {
            saveToImage();
        });
        display.scale(1);
        $(window).on('resize', function() {
            var vmWidth = $('.g-main').width();
            var vmHeight = $('.g-main').height();
            winW = vmWidth;
            winH = vmHeight;
            var wWH = winW / winH;
            if (wWH > (x / y)) {
                display.scale(winH / y);
            } else {
                display.scale(winW / x);
            }
        });
        // 初始化显示，鼠标和键盘
        // 鼠标
        mouse.onmousedown =
        mouse.onmouseup   =
        mouse.onmousemove = myMouseMove;
        
        // 键盘
        keyboard.onkeydown = keydownEvent;
        keyboard.onkeyup = keyupEvent;
        
        // 获取虚拟机剪切板
        guac.onclipboard = function(stream, mimetype) {
            // Only text/plain is supported for now
            if (mimetype !== 'text/plain') {
                stream.sendAck('只支持text/plain', Guacamole.Status.Code.UNSUPPORTED);
                return;
            }

            var reader = new Guacamole.StringReader(stream);
            var data = '';

            // Append any received data to buffer
            reader.ontext = function(text) {
                data += text;
                stream.sendAck('获取剪切板成功', Guacamole.Status.Code.SUCCESS);
            };

            // Update state when done
            reader.onend = function() {
                console.log(data);
                c.val(data);
            };
            console.log(stream);
        },
        l.on("click", function () {
            var t = c.val();
            guac.setClipboard(t);
            //e.flashMessage("success", "保存成功，请在实验环境中粘贴")
        });
    }
    $("#display").click(function(){
        $("#vmchange").blur(); 
        keyboard.onkeydown = keydownEvent;
        keyboard.onkeyup = keyupEvent;
    });
    
});
function myFocus(){
    keyboard.onkeydown = null;
    keyboard.onkeyup = null;
}
function myBlur(){
    keyboard.onkeydown = keydownEvent;
    keyboard.onkeyup = keyupEvent;
}

 //============================================================ 评论和问答=============================================================//   
function words_deal() { 
    var curLength=$("#discuss").val().length; 
    if(curLength>140){ 
      layer.alert("超过字数限制！" ); 
    }else{
      $(".num").text(140-$("#discuss").val().length); 
    } 
}
function words_deal1() { 
    var curLength=$("#note").val().length; 
    if(curLength>1000){ 
      layer.alert("超过字数限制！" ); 
    }else{
      $(".notesNum").text(1000-$("#note").val().length); 
    } 
}
function release (obj){
    var star = '1';
    $(".userSetTab dt").each(function (){
        var li = $(this).attr("class");
        if(li == 'cur'){
            var c = $(this).html();
            if(c == "<i></i>吐槽"){
              star = '2';
            }
            if(c == "<i></i>问题"){
              star= '1' ;
            }
        }
    });
    var count = $(obj).parent().parent().find(".chackTextarea").val();
    var url = '/course/play/reply';
    if(count == ''){
      layer.alert("总得说点什么吧？");
    }else{
        if(count == "聚焦学习疑问"){
            layer.alert("总得说点什么吧？");
        }else{
            if(count.length > 140 ||  count.length < 0){
                layer.alert("超过字数限制！" );
            }else if(count.length < 0){
                layer.alert("总得说点什么吧？");
            }else{
                $.ajax({
                    dataType: 'JSON', //数据类型
                    type: "POST",
                    url: url,
                    data:{
                        chapter_id:'29',
                        to_student_id:0,
                        parent_id:0,
                        main_parent_id:0,
                        state:1,
                        content:count,
                        courseware_id:'8142',
                        courseware_id_true:'8142',
                    },
                    beforeSend:function(XMLHttpRequest){
                        $(obj).val("提交中");
                        $(obj).attr("onclick","");
                    },
                    success: function (data) {
                        $(obj).val("提交");
                        $(obj).attr("onclick","release(this)");
                        $(".num").text(140); 
                        if(data == 1){
                            $(obj).parent().parent().find(".chackTextarea").val("");
                            $(".pl-list-wrap li").remove("");
                            discussList('#discuss_loadmore', 'discusslist_script', 'reply_ul', '/course/play/discusslist','8142','29',"");
                        }else{
                            if(data == -100){
                                layer.alert("课节id错误，不能回复！");
                            }else if (data == -101){
                                window.location.href='/'; 
                            }else if (data == -102){
                                layer.alert("对不起，当前登录账号没有权限");
                            }else if (data == -103){
                                layer.alert("课程id错误，不能回复");
                            }else if (data == -104){
                                layer.alert("实验id错误，不能回复！");
                            }else if (data == -105){
                                layer.alert("当前回复的问答不存在，不能回复");
                            }else{
                                layer.alert("问题发布失败");
                            }
                        }
                    }
                });
            }
        } 
    }
}
function releaseNote(obj){
    var isshart = $("#share").attr("class"); 
    if(isshart == "share"){
      isshart = 0 ;
    }else{
      isshart =1 ;
    }
    var count = $("#note").val();
    var url = '/course/play/addnote';
    if(count == ''){
        layer.alert("笔记不能空着啊");
    }else{
        if(count == "记录学习点滴"){
            layer.alert("笔记不能空着啊");
        }else{
            if(count.length > 1000){
                layer.alert("超过字数限制！" );
            }else if(count.length < 0){
                layer.alert("笔记不能空着啊");
            }else{
              $.ajax({
                //dataType: 'JSON', //数据类型
                type: "POST",
                url: url,
                data:{
                  'courseware_id':'8142',
                  'count':count,
                  'isshart': isshart,
                  'chapter_id':'29',
                },
                beforeSend:function(XMLHttpRequest){
                    $(obj).val("提交中");
                    $(obj).attr("onclick","");
                },
                success: function (data) {
                    $("#note").val("");
                    $(obj).val("提交");
                    $(obj).attr("onclick","releaseNote(this)");
                    $(".notesNum").text(1000); 
                    if(data == 1){
                        $(".notes-list-wrap li").remove("");
                        noteList('#note_loadmore', 'note_script', 'note_ul', '/course/play/notelist','8142','29',"");
                    }else{
                                                if (data == -104){
                            layer.alert("实验id错误，不能回复！");
                        }else{
                            layer.alert("笔记提交失败");
                        }
                    }
                }
              });
            }
        }
    }

}

</script> 
</html>